<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.29.3"/><title data-react-helmet="true">Onichandame&#x27;s Home-An Epics Proxy | Onichandame&#x27;s Home</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="An Epics Proxy"/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Xiao Zhang"/><meta data-react-helmet="true" name="twitter:title" content="An Epics Proxy"/><meta data-react-helmet="true" name="twitter:description" content=""/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link as="script" rel="preload" href="/webpack-runtime-d10adb79bdd5453eb719.js"/><link as="script" rel="preload" href="/framework-beda7bde9d7dca0755ce.js"/><link as="script" rel="preload" href="/4bdf9057-9e84789d24bbe2abd5b4.js"/><link as="script" rel="preload" href="/fb7d5399-58798ebfc9c8cc593565.js"/><link as="script" rel="preload" href="/d5b08420-07f367315fbba8850a0e.js"/><link as="script" rel="preload" href="/app-480180644c77b18facab.js"/><link as="script" rel="preload" href="/c67bc222f24cf6cac9dade081f06b9686691a306-5cb5fd77d6c6846ab638.js"/><link as="script" rel="preload" href="/component---src-template-blog-tsx-dc3e87313bcd461c5423.js"/><link as="fetch" rel="preload" href="/page-data/post/an-epics-proxy/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/440568431.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/840944156.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/899237799.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/899237799.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="position:fixed;top:0;right:0;bottom:0;left:0"><div style="position:relative;width:100%;height:100%;overflow:hidden"><canvas style="display:block"></canvas></div></div><div style="pointer-events:stroke;position:absolute;width:100vw"><div><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionSticky MuiAppBar-colorPrimary jss2 MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><h6 class="MuiTypography-root MuiTypography-h6"><a class="jss6" href="/">Onichandame&#x27;s Home</a></h6></div><div class="MuiGrid-root MuiGrid-item"><a class="jss6" href="/post"><span class="MuiTypography-root MuiTypography-button">blog</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss6" href="/about"><span class="MuiTypography-root MuiTypography-button">about</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss6" href="/contact"><span class="MuiTypography-root MuiTypography-button">contact</span></a></div></div></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><div><button class="MuiButtonBase-root MuiButton-root MuiButton-text" tabindex="0" type="button" aria-controls="language-selector" aria-haspopup="true"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></span></button></div></div><div class="MuiGrid-root MuiGrid-item"><a class="MuiButtonBase-root MuiIconButton-root" tabindex="0" aria-disabled="false" href="https://github.com/onichandame"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path></svg></span></a></div></div></div></div></div></header><main class="jss1"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-direction-xs-column"><div class="MuiGrid-root MuiGrid-item"><h3 class="MuiTypography-root MuiTypography-h3">An Epics Proxy</h3></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">onichandame</span></div><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">2020-4-28</span></div></div></div><div class="MuiGrid-root MuiGrid-item"><ul><li><a href="#background">Background</a></li><li><a href="#scenario">Scenario</a></li><li><a href="#technical-consideration">Technical Consideration</a></li><li><a href="#design">Design</a><ul><li><a href="#data-flow">Data Flow</a></li><li><a href="#communication-protocol">Communication Protocol</a></li><li><a href="#framework">Framework</a></li></ul></li><li><a href="#implementation">Implementation</a><ul><li><a href="#feasibility">Feasibility</a></li><li><a href="#setup-apollo-server">Setup Apollo Server</a></li><li><a href="#connect-to-ioc">Connect to IOC</a></li></ul></li><li><a href="#deployment">Deployment</a></li><li><a href="#links">Links</a></li></ul><h1>Background</h1><p><a href="https://epics-controls.org/">EPICS</a> is a well-known framework for controlling a wide range of hardware. Just like other inventions from the particle physicists, it reaches beyond the field of the particle physics experiments.</p><h1>Scenario</h1><p><a href="https://epics-controls.org/">EPICS</a> provides a comprehensive bucket of tools for almost all use cases. In the age of the internet, however, many unprecedented demands have emerged. One of which is to allow remote control over the internet.</p><p>Here comes a trivial problem that has never been addressed before: how to communicate as a web front with the EPICS IOCs?</p><h1>Technical Consideration</h1><p>As a never-before new system, one of the most fundamental engineering principles is to stick with the existing standards as much as possible. Based on this principle, 3 sub-principles must be followed.</p><ol><li>use loosely-coupled microservices each provides a limited and well-defined functionality</li><li>communication protocols and data structure are kept simple and consistent across the smallest necessary scope.</li><li>use standardized protocols, deployment workflow, and libraries</li></ol><p>Hence a bridge between IOCs of the 20th century and the web frameworks of the 21st century is necessary.</p><h1>Design</h1><h2>Data Flow</h2><p>The data flow is the foundation of any software system and should be drafted before the actual development.</p><p><img src="/image/epics-proxy.png" alt="hi"/></p><p>As seen above, the web services communicates with the IOC through a proxy. The proxy ought to be able to translate the web protocols to Epics protocols and vice versa.</p><h2>Communication Protocol</h2><p>According to the basic structure, the proxy needs to handle 2 types of protocols: one for the web services and one for the IOCs. The former has many standards I can choose from. The latter only has two standards at the moment: CA and PV.</p><p>As PV is only available to EPICS 7+, for better compatibility of the proxy, CA should be supported first.</p><p>Considering that <code>caget</code> <code>caput</code> are compatible with the stateless protocols, but <code>camonitor</code> requires a stateful protocol like WebSocket, the protocol to the microservices must support both cases. Hence the most popular communication protocol HTTP-based REST is not an option. After a quick research, GraphQL from Facebook is found to satisfy all the demands.</p><h2>Framework</h2><p>Both CA and GraphQL are too complicated to make from scratch. Therefore some existing frameworks must be utilized. Based on the choice of the protocols, 2 frameworks are required:</p><ol><li>a GraphQL server</li><li>a CA library</li></ol><p>The most popular GraphQL server is the apollo-server, and it is the only server that supports real-time subscriptions out of the box.</p><p>The only CA library comes from EPICS-base, in the form of dynamic libraries and executable binaries.</p><h1>Implementation</h1><p>The development of the proxy was not smooth and simple, therefore I will divide this section into challenges.</p><h2>Feasibility</h2><p>The very first question is: is such proxy even possible?</p><p>This question can be broken down into 2:</p><ol><li>is it possible to integrate CA library with GraphQL server?</li><li>is the proxy able to communicate with the IOCs on the other hosts in the network?</li></ol><p>The first question is answered by <a href="https://github.com/pyepics/pyepics">this tool</a> and <a href="https://github.com/RobbieClarken/node-epics">this tool</a>. Thanks to the great pioneers who made these tools!</p><p>The second question can be cleared by a simple test using the tools mentioned above.</p><h2>Setup Apollo Server</h2><p>GraphQL is way more complicated than it sounds if you are new to it. There are many useful resources out there to help newbies set up their first server. I found <a href="https://www.apollographql.com/docs/apollo-server/getting-started/">this</a> and <a href="https://typegraphql.com/">this</a> to be very helpful.</p><p>The biggest challenge here is to understand the concept of the resolver. It is a standardized component of GraphQL so many different packages can work together without a problem. As I use TypeScript to code, <a href="https://typegraphql.com/">type-graphql</a> suits my needs best. Although a code-first GraphQL server is better, the Apollo server does not support the code-first approach.</p><p>Having implemented <code>caget</code>, <code>caput</code> and <code>camonitor</code> as <code>Query</code>, <code>Mutation</code> and <code>Subscription</code> respectively, the server part is done.</p><h2>Connect to IOC</h2><p>Here comes the most tricky part. As Apollo Server only runs with Node.js, using JS/TS is the only choice. However, <a href="https://github.com/RobbieClarken/node-epics">node-epics</a> is too old to support the latest Node.js. Hence I made <a href="https://github.com/onichandame/epics-ioc-connection/">my own fork</a>.</p><p>After some head-scratching, <a href="https://github.com/onichandame/epics-ioc-connection/">this tool</a> is published. The connection to the IOC is easily implemented and tested.</p><p>This issue took me a week before the first version is published whereas the other issues only took me a couple of days.</p><h1>Deployment</h1><p>As the proxy relies on a specific version of the Node, it is better shipped with the Node of the correct version. Hence docker is the best solution.</p><p>Personally I use Kubernetes to manage the containers. I recommend anyone who needs docker to consider to switch to Kubernetes as it is just awesome.</p><h1>Links</h1><p><a href="https://github.com/onichandame/epics-proxy/">click here</a> for the proxy
<a href="https://github.com/onichandame/epics-ioc-connection/">click here</a> for the JS binding of CA</p></div></div></main><footer>© <!-- -->2021<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/an-epics-proxy";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-b7eaa380a7ed2e7f6e7f.js"],"app":["/app-480180644c77b18facab.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-b0556ce5127c1a3e2490.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-a5780fd25427dba554e6.js"],"component---src-pages-contact-tsx":["/component---src-pages-contact-tsx-6e01bfbd9b9e3535a9b7.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-f451d7b1cde1ede15351.js"],"component---src-pages-post-tsx":["/component---src-pages-post-tsx-006378b48e558ceea283.js"],"component---src-template-blog-tsx":["/component---src-template-blog-tsx-dc3e87313bcd461c5423.js"],"component---src-template-resume-tsx":["/component---src-template-resume-tsx-c936ed4b5c03d9e27001.js"]};/*]]>*/</script><script src="/polyfill-b7eaa380a7ed2e7f6e7f.js" nomodule=""></script><script src="/component---src-template-blog-tsx-dc3e87313bcd461c5423.js" async=""></script><script src="/c67bc222f24cf6cac9dade081f06b9686691a306-5cb5fd77d6c6846ab638.js" async=""></script><script src="/app-480180644c77b18facab.js" async=""></script><script src="/d5b08420-07f367315fbba8850a0e.js" async=""></script><script src="/fb7d5399-58798ebfc9c8cc593565.js" async=""></script><script src="/4bdf9057-9e84789d24bbe2abd5b4.js" async=""></script><script src="/framework-beda7bde9d7dca0755ce.js" async=""></script><script src="/webpack-runtime-d10adb79bdd5453eb719.js" async=""></script></body></html>