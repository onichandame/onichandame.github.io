<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.21.21"/><title data-react-helmet="true">Onichandame&#x27;s Home-Single Node K8s in China | Onichandame&#x27;s Home</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="Single Node K8s in China"/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Xiao Zhang"/><meta data-react-helmet="true" name="twitter:title" content="Single Node K8s in China"/><meta data-react-helmet="true" name="twitter:description" content=""/><link rel="icon" href="/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link as="script" rel="preload" href="/webpack-runtime-dd010bb15fdd0a8981a1.js"/><link as="script" rel="preload" href="/framework-0c157ddbcea1bac94383.js"/><link as="script" rel="preload" href="/4bdf9057-d1f2f728a56eb4896986.js"/><link as="script" rel="preload" href="/fb7d5399-1756c3d3f6f764424c9f.js"/><link as="script" rel="preload" href="/d5b08420-0d926a1945c521a381de.js"/><link as="script" rel="preload" href="/app-3f35f0fcbd929fd5a7de.js"/><link as="script" rel="preload" href="/c67bc222f24cf6cac9dade081f06b9686691a306-b4418df3ce7b0918796c.js"/><link as="script" rel="preload" href="/component---src-template-blog-tsx-538be02797d6b4522b70.js"/><link as="fetch" rel="preload" href="/page-data/post/single-node-k8s/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="position:fixed;top:0;right:0;bottom:0;left:0"><div style="position:relative;width:100%;height:100%;overflow:hidden"><canvas style="display:block"></canvas></div></div><div style="pointer-events:stroke;position:absolute;width:100vw"><div><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionSticky MuiAppBar-colorPrimary jss2 MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><h6 class="MuiTypography-root MuiTypography-h6"><a class="jss182" href="/">Onichandame&#x27;s Home</a></h6></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/post"><span class="MuiTypography-root MuiTypography-button">blog</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/about"><span class="MuiTypography-root MuiTypography-button">about</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/contact"><span class="MuiTypography-root MuiTypography-button">contact</span></a></div></div></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><div><button class="MuiButtonBase-root MuiButton-root MuiButton-text" tabindex="0" type="button" aria-controls="language-selector" aria-haspopup="true"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></span></button></div></div><div class="MuiGrid-root MuiGrid-item"><a class="MuiButtonBase-root MuiIconButton-root" tabindex="0" aria-disabled="false" href="https://github.com/onichandame"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path></svg></span></a></div></div></div></div></div></header><main class="jss1"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-direction-xs-column"><div class="MuiGrid-root MuiGrid-item"><h3 class="MuiTypography-root MuiTypography-h3">Single Node K8s in China</h3></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">onichandame</span></div><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">2019-4-7</span></div></div></div><div class="MuiGrid-root MuiGrid-item"><ul><li><a href="#scenario">Scenario</a></li><li><a href="#materials">Materials</a></li><li><a href="#procedures">Procedures</a><ul><li><a href="#install-os">Install OS</a></li><li><a href="#configure-firewall">Configure Firewall</a></li><li><a href="#setup-bridge">Setup Bridge</a></li><li><a href="#setup-container-runtime">Setup Container Runtime</a></li><li><a href="#install-kubectl-kubelet-and-kubeadm">Install kubectl, kubelet and kubeadm</a></li><li><a href="#boot">Boot</a></li><li><a href="#setup-kubectl">Setup kubectl</a></li><li><a href="#install-network-plugin">Install Network Plugin</a></li><li><a href="#turn-off-master-protection">Turn off Master Protection</a></li><li><a href="#install-load-balancer">Install Load Balancer</a></li><li><a href="#install-ingress-controller">Install Ingress Controller</a></li></ul></li><li><a href="#%E7%BB%93%E8%AF%AD">结语</a></li></ul><h1 id="scenario">Scenario</h1><p>My new project needs to run on a remote physical machine. The project itself is coposed of many microservices. Therefore the best way to deploy is container orchestration. But the constraints of k8s plus physical machine plush China introduces many complexities to the setup.</p><h1 id="materials">Materials</h1><p>The materials in hand are:</p><ul><li>one physical server<ul><li>CPU：E3-1220v6</li><li>RAM：32GB</li><li>HDD：4TB</li></ul></li><li>A series of vacant IP address in LAN</li></ul><h1 id="procedures">Procedures</h1><h2 id="install-os">Install OS</h2><p>I choose the latest CentOS 7 as CentOS 8 still lacks the official support to docker. If choose not to use docker or containerd, CentOS 8 is fine. Other distros are not recommended here as I haven&#x27;t tried them.</p><h2 id="configure-firewall">Configure Firewall</h2><p>According to the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">official docs</a>, the master and the worker require 7 ports and 1 series of ports open. According to <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">the docs</a>, 2 more ports need to be open in order to use flannel. And according to <a href="https://docs.nginx.com/nginx-ingress-controller/installation/installation-with-manifests/">the docs</a>, port 80 and 443 need to be opened.</p><pre><code class="language-bash">firewall-cmd --zone=public --permanent --add-port=443/tcp
firewall-cmd --zone=public --permanent --add-port=80/tcp
firewall-cmd --zone=public --permanent --add-port=6443/tcp
firewall-cmd --zone=public --permanent --add-port=2379-2380/tcp
firewall-cmd --zone=public --permanent --add-port=10250-10252/tcp
firewall-cmd --zone=public --permanent --add-port=8285/tcp
firewall-cmd --zone=public --permanent --add-port=8472/tcp
firewall-cmd --reload
</code></pre><h2 id="setup-bridge">Setup Bridge</h2><p>According to the <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">official docs</a>, the network bridge needs to be setup.</p><pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sysctl --system
</code></pre><p>Note: Check the output of <code>lsmod | grep br_netfilter</code>is not empty before running the above commands. If empty, it is requried to run <code>modprobe br_netfilter</code> and check again.</p><h2 id="setup-container-runtime">Setup Container Runtime</h2><p>I choose to use docker. The detailed steps are described <a href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#docker">here</a>. But I did it according to the CentOS&#x27;s official recommendation. If you choose containerd or cri-o, please refer to the official guides.</p><pre><code class="language-bash">yum install epel-release -y
yum install docker-ce -y
</code></pre><h2 id="install-kubectl-kubelet-and-kubeadm">Install kubectl, kubelet and kubeadm</h2><p>Next step is to install the deployment tools.</p><pre><code class="language-bash">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-$basearch
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kubelet kubeadm kubectl
EOF

# Set SELinux in permissive mode (effectively disabling it)
setenforce 0
sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config

yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

systemctl enable --now kubelet
</code></pre><p>Now that kubelet is ready to use. The next step is to bootstrap the cluster.</p><h2 id="boot">Boot</h2><p>Having done all the steps above, it is time to boot the cluster.</p><pre><code class="language-bash">kubeadm init --pod-network-cidr=10.244.0.0/16 --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers
</code></pre><p>As I choose to use flannel, <code>--pod-network-cidr=10.244.0.0/16</code> is required. As I am deploying in China, a mirror is required <code>--image-repository registry.cn-hangzhou.aliyuncs.com/google_containers</code>.</p><p>The <code>kubeadm join &lt;control-plane-host&gt;:&lt;control-plane-port&gt; --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;</code> part from the output needs to be recorded in case new nodes will be added in the future.</p><h2 id="setup-kubectl">Setup kubectl</h2><p>如果当前用户非root，需要配置kubectl以连接集群。
If the current user is not root, kubectl needs to be configured in order to connect to the cluster.</p><pre><code class="language-bash">mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
</code></pre><p>If the current user is root, <code>export KUBECONFIG=/etc/kubernetes/admin.conf</code> is requried to setup kubectl.</p><h2 id="install-network-plugin">Install Network Plugin</h2><p>As k8s is designed for cluster, pods from different hosts require a network plugin to communicate through LAN. According to <a href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/#pod-network">the official docs</a>, I choose flannel. I have seen a report that other plugins fail as DNS where flannel is stil functional. The source of the report is lost in my memory though.</p><pre><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml
</code></pre><h2 id="turn-off-master-protection">Turn off Master Protection</h2><p>k8s by default does not allow master to run non-system pods. But I need to run workloads on master so this protection needs to be turned off.</p><pre><code class="language-bash">kubectl taint nodes --all node-role.kubernetes.io/master-
</code></pre><h2 id="install-load-balancer">Install Load Balancer</h2><p>On the cloud like AWS or GKE, service can retrieve a public IP easily using LoadBalancer. But this function depends on the cloud provider&#x27;s load balancer. Now it is requried to install a load balancer. I choose MetalLB. <a href="https://metallb.universe.tf/installation/">Here</a> is the official docs.</p><p>Firstly edit the kube-proxy configuration:</p><pre><code class="language-bash">kubectl edit configmap -n kube-system kube-proxy
</code></pre><p>Add <code>strictARP: true</code> under <code>ipvs</code>.</p><p>I haven&#x27;t learned the fundamental reasons behind this, but I guess that it has something to do with the arp mechanism.</p><p>Now it is ready to deploy MetalLB service:</p><pre><code class="language-bash">kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.9.3/manifests/namespace.yaml
kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.9.3/manifests/metallb.yaml
kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey=&quot;$(openssl rand -base64 128)&quot;
</code></pre><p>Now that you can check if MetalLB related containers are online using <code>kubectl get pods --all-namespaces</code>.</p><p>The next step is to configure MetalLB. In a nutshell MetalLB needs to know what IP addresses can be distributed to the services.</p><p>Open a new yaml file and add the content:</p><pre><code class="language-yaml">apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.1.240-192.168.1.250
</code></pre><p>The addresses value specifies the available IP addresses. All other configurations can be left unchanged.</p><p>MetalLB can now be deployed by <code>kubectl apply -f &lt;config file&gt;</code>.</p><p>The cluster can now deploy service of the type LoadBalancer.</p><h2 id="install-ingress-controller">Install Ingress Controller</h2><p>LoadBalancer is the most common service type, but a bunch of IP is not easy to manage. Since k8s 1.1 there is a new resource type of Ingress. It functions like Apache or Nginx to provide a more convenient control over the incoming traffic.</p><p>One of Ingress&#x27;s functions is the route according to the domain. For instance there are 2 domains now, aaa.com and bbb.com each served by server A and server B. After domain resolution both are pointing to the same IP, the IP of the node where the Ingress controller is run. When a viewer visits aaa.com, Ingress routes the traffic to server A. The same logic applies to the server B.</p><p>To be able to use Ingress, an Ingress Controller needs to be installed.</p><p>I choose Nginx-Ingress. The first step is to clone the configuration files.</p><pre><code class="language-bash">git clone https://github.com/nginxinc/kubernetes-ingress/ --single-branch --branch v1.6.3
</code></pre><p>Now cd into the sub directory deployments and run the following commands in order.</p><pre><code class="language-bash">kubectl apply -f common/ns-and-sa.yaml
kubectl apply -f rbac/rbac.yaml
kubectl apply -f common/default-server-secret.yaml
kubectl apply -f common/nginx-config.yaml
kubectl apply -f common/custom-resource-definitions.yaml
kubectl apply -f daemon-set/nginx-ingress.yaml
</code></pre><p>Now check if nginx-ingress is online using <code>$ kubectl get pods --namespace=nginx-ingress</code>.</p><h1 id="conclusion">Conclusion</h1><p>Now if everything went fine, a single-node k8s cluster is ready to use. All features of k8s 1.18 are supported.</p></div></div></main><footer>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/single-node-k8s";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-3f35f0fcbd929fd5a7de.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-ac91495a5202f90f8ab8.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-66565a40f9652498fa6b.js"],"component---src-pages-contact-tsx":["/component---src-pages-contact-tsx-68fa4e4b721688547eee.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-f4903804c4ca62b23001.js"],"component---src-pages-post-tsx":["/component---src-pages-post-tsx-78f64c5d17e26af2825d.js"],"component---src-template-blog-tsx":["/component---src-template-blog-tsx-538be02797d6b4522b70.js"],"component---src-template-resume-tsx":["/component---src-template-resume-tsx-52fd3ffeb5c949b46b9c.js"]};/*]]>*/</script><script src="/component---src-template-blog-tsx-538be02797d6b4522b70.js" async=""></script><script src="/c67bc222f24cf6cac9dade081f06b9686691a306-b4418df3ce7b0918796c.js" async=""></script><script src="/app-3f35f0fcbd929fd5a7de.js" async=""></script><script src="/d5b08420-0d926a1945c521a381de.js" async=""></script><script src="/fb7d5399-1756c3d3f6f764424c9f.js" async=""></script><script src="/4bdf9057-d1f2f728a56eb4896986.js" async=""></script><script src="/framework-0c157ddbcea1bac94383.js" async=""></script><script src="/webpack-runtime-dd010bb15fdd0a8981a1.js" async=""></script></body></html>