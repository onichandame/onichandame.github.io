<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.32.3"/><title data-react-helmet="true">Onichandame&#x27;s Home-React-based 3D Components | Onichandame&#x27;s Home</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="React-based 3D Components"/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Xiao Zhang"/><meta data-react-helmet="true" name="twitter:title" content="React-based 3D Components"/><meta data-react-helmet="true" name="twitter:description" content=""/><link rel="icon" href="/favicon-32x32.png?v=4a9773549091c227cd2eb82ccd9c5e3a" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=4a9773549091c227cd2eb82ccd9c5e3a"/><link as="script" rel="preload" href="/webpack-runtime-38050ada14d0c54770e0.js"/><link as="script" rel="preload" href="/framework-beda7bde9d7dca0755ce.js"/><link as="script" rel="preload" href="/4bdf9057-bb8d6e3074bb6e323a3e.js"/><link as="script" rel="preload" href="/fb7d5399-58798ebfc9c8cc593565.js"/><link as="script" rel="preload" href="/d5b08420-07f367315fbba8850a0e.js"/><link as="script" rel="preload" href="/app-5c2916b261110a942aba.js"/><link as="script" rel="preload" href="/c67bc222f24cf6cac9dade081f06b9686691a306-5cb5fd77d6c6846ab638.js"/><link as="script" rel="preload" href="/component---src-template-blog-tsx-511ea8db97ab7255d585.js"/><link as="fetch" rel="preload" href="/page-data/post/react-based-3d-components/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/440568431.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/840944156.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/899237799.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/899237799.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="position:fixed;top:0;right:0;bottom:0;left:0"><div style="position:relative;width:100%;height:100%;overflow:hidden"><canvas style="display:block"></canvas></div></div><div style="pointer-events:stroke;position:absolute;width:100vw"><div><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionStatic MuiAppBar-colorPrimary jss2 MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><h6 class="MuiTypography-root MuiTypography-h6"><a class="jss7" href="/">Onichandame&#x27;s Home</a></h6><div class="jss3"><a class="jss7" href="/post"><span class="MuiTypography-root MuiTypography-button">blog</span></a></div><div class="jss3"><a class="jss7" href="/about"><span class="MuiTypography-root MuiTypography-button">about</span></a></div><div class="jss3"><a class="jss7" href="/contact"><span class="MuiTypography-root MuiTypography-button">contact</span></a></div><div style="flex-grow:1"></div><div style="flex-grow:1"></div><div><button class="MuiButtonBase-root MuiButton-root MuiButton-text" tabindex="0" type="button" aria-controls="language-selector" aria-haspopup="true"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></span></button></div><a class="MuiButtonBase-root MuiIconButton-root" tabindex="0" aria-disabled="false" href="https://github.com/onichandame"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path></svg></span></a></div></header><main class="jss1"><div class="MuiGrid-root MuiGrid-container MuiGrid-direction-xs-column"><div class="MuiGrid-root MuiGrid-item"><h3 class="MuiTypography-root MuiTypography-h3">React-based 3D Components</h3></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">onichandame</span></div><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">2020-5-13</span></div></div></div><div class="MuiGrid-root MuiGrid-item" style="padding:16px"><ul><li><a href="#background">Background</a></li><li><a href="#demand-analysis">Demand Analysis</a><ul><li><a href="#end-user-experience">End-User Experience</a></li><li><a href="#technical-constraints">Technical Constraints</a></li></ul></li><li><a href="#technology-analysis">Technology Analysis</a><ul><li><a href="#react-360">React 360</a></li><li><a href="#babylon">Babylon</a></li><li><a href="#three-based-solution">Three-based Solution</a><ul><li><a href="#react-three-fiber">React-Three-Fiber</a></li></ul></li></ul></li><li><a href="#implementation">Implementation</a><ul><li><a href="#design">Design</a></li><li><a href="#model-loading">Model Loading</a></li><li><a href="#viewport-movement">Viewport Movement</a></li></ul></li></ul><p>This is a record of my personal experience on the 3D React component development. The content may be updated at any time because the project is still under development.</p><h1>Background</h1><p>I need to design and build a 3D based building information modelling(BIM). This BIM component needs to reside in an existing system based on Next.js, a UI framework based on React and specialized in SSR optimization.</p><h1>Demand Analysis</h1><h2>End-User Experience</h2><p>The end user is an untrained worker who is not specialzed in either IT or BIM. Therefore the functions are simple and understandable for every computer user.</p><ol><li>An intrinsic mapping between the UI and the real building, down to the component level</li><li>An intrinsic interactive pattern based on ray casting</li><li>All texts and numbers on the UI must be clear and minimal</li><li>A camera reset button, a scene reload button and a virtual button on each component to enter the corresponding page of details</li></ol><h2>Technical Constraints</h2><ol><li>Must be integrated into a Next.js project</li><li>Must be able to load 3D models like GLTF and OBJ</li><li>Must be code-splitted to minimize the impact on the performance of the original website</li></ol><h1>Technology Analysis</h1><p>Based on the demand analysis, I conducted research to find some existing technologies that I can make use of. Many good frameworks are found but they all boils down to 3 fundamental technologies.</p><h2>React 360</h2><p>This is a framework built by Facebook for VR development. It also supports 3D UI out of the box. By default it loads models from GLTF and OBJ formats. At the first glance it may be the best choice for the following reasons:</p><ol><li>3D out of the box</li><li>interactive out of the box</li><li>supports open source models GLTF and OBJ</li></ol><p>But it is based on React Native, which makes it difficult to integrate into the existing webpage. Truly it can be embedded in <code>&lt;iframe&gt;</code>. But this workaround brings more complexities into the deployment phase. Moreover, this framework aims at VR, which is not a 100% overlap with BIM. Not to say that this framework is not as popular as its competitors, which means that it is more defficult to get help from the community.</p><h2>Babylon</h2><p>This framework supports the integration with React officially, according to the <a href="https://doc.babylonjs.com/resources/babylonjs_and_reactjs">official docs</a>. However the docs also mentions that there may be performance overhead if used with React. The optimal choice is to use the pure JavaScript, which is what I would like to avoid. There are feasible ways such as React DOM or reconciler. But again the community is quite small. <a href="https://github.com/brianzinn/react-babylonjs">The existing solution</a> has just 140 stars on GitHub at the time of writing this sentence. As an individual developer the size of community is at the top of my list.</p><h2>Three-based Solution</h2><p>Now the main course comes. Three.js is the most popular 3D framework in Web development. It has the largest most active community. However, it is not designed for React hence the React-Three community is not comparable to the entire Three community.</p><h3><a href="https://www.npmjs.com/package/react-three-fiber">React-Three-Fiber</a></h3><p>This is the most suitable framework in this condition.</p><ol><li>Deep integration with React with no significant performance overhead</li><li>Able to load GLTF models using useLoader hook, GLTF loader from Three and React Suspense</li><li>Just a wrapper around three so info from three community is most likely helpful</li><li>Many helper packages from the same team that help ray casting, animation and more.</li></ol><p>The only hack needed here is the dynamic import of Next.js with SSR disabled. It is not a traditional hack that needs a proper fix, but a non-intuitive but reasonable solution for the problem: 2D rendering is compatible with SSR as SSR produces plain HTML, but 3D requires runtime loading of the resources such as models. If models are wrapped in React components, these components must be dynamically loaded using <code>next/dynamic</code>.</p><p>Also, dynamic importing of Next.js provides code-splitting out of the box.</p><h1>Implementation</h1><p>This sections records all the major challenges solved during implementation. Basic knowledge of React and 3D development is preassumed.</p><h2>Design</h2><p>As BIM is designed to convey the position and the status of physical components, It should display all the information in one screen for a comprehensive overview of the components. Based on this principle, all components should be layed out in one plane. Thus the camera movement can be constrained to the same plane.</p><p><img src="/image/bim-example.jpg" alt="example"/></p><p>As shown in the above example, all components are visible in one snapshot. The shape and location are displayed by the model itself and the status is displayed by the color.</p><p>The only interactions between BIM and the user are summarized into 2:</p><ol><li>enter the component&#x27;s control panel by clicking on the component</li><li>reset the camera position to initial</li></ol><p>The first interaction can be achieved by capturing the &quot;click&quot; event on each component.</p><p>The second interaction can be achieved by clicking a reset button in the corner.</p><h2>Model Loading</h2><p>The first problem encountered is to load the models made by the designer. As stated in <a class="" href="/post/collaboration-using-blender">this post</a>, it is possible to convert models made in SolidWorks to Blender. From Blender, the model can be exported as GLTF files.</p><p><a href="https://www.npmjs.com/package/react-three-fiber">R3F</a> provides a hook <code>useLoader</code> that can be used in conjunction with <code>GLTFLoader</code> from three to dynamically load GLTF files into the model.</p><pre><code class="language-typescript">import { useLoader } from &quot;react-three-fiber&quot;
import { GLTFLoader } from &quot;three/examples/jsm/loaders/GLTFLoader&quot;

export const Model = () =&gt; {
  const gltf = useLoader(GLTFLoader, &quot;/static/model.gblb&quot;)
  return &lt;primitive object={gltf.scene} dispose={null} {...other} /&gt;
}
</code></pre><h2>Viewport Movement</h2><p>There are mainly 2 ways to move the viewport: moving the camera(first-person) or moving the model(god&#x27;s view). These 2 methods do not differentiate when translating, so the choice is made based on the demanded rotation pattern.</p><p>In a big scene where it is impossible to contain all models in one frustrum, the first-person strategy is more intuitive. In a scene where all models can be contained in one frustrum, a god&#x27;s view is the better choice.</p><p>As for BIM, all models should be displayed in one screen so god&#x27;s view should be adopted.</p><p>God&#x27;s view can be implemented using <code>useGesture</code> from <code>react-use-gesture</code> and <code>useSpring</code> from <code>@react-spring/core</code>.</p><pre><code class="language-typescript">import { a } from &#x27;@react-spring/three&#x27;
const useControl = (
  ...[xBounds, yBounds, zBounds, { domTarget }]: Props
): [
  { x: SpringValue&lt;number&gt;; y: SpringValue&lt;number&gt;; z: SpringValue&lt;number&gt; },
  ReturnType&lt;typeof useGesture&gt;
] =&gt; {
  const [{ x }, setX] = useSpring&lt;{ x: number }&gt;(() =&gt; ({
    x: 0,
    config: config.slow,
  }))
  const [{ y }, setY] = useSpring&lt;{ y: number }&gt;(() =&gt; ({
    y: 5,
    config: config.slow,
  }))
  const [{ z }, setZ] = useSpring&lt;{ z: number }&gt;(() =&gt; ({
    z: 5,
    config: config.slow,
  }))
  const zoom = useCallback(
    ({ wheeling, xy: [, newY], previous: [, oldY], memo = z.get() }) =&gt; {
      if (wheeling) {
        const newZ = clamp(memo + newY - oldY, ...zBounds)
        setZ({ z: newZ })
        return newZ
      } else {
        return memo
      }
    },
    [zBounds, z, setZ]
  )
  const drag = useCallback(
    ({ dragging, offset: [newX, newY], memo = [x.get(), y.get()] }) =&gt; {
      if (dragging) {
        setX({ x: newX })
        setY({ y: -newY })
        return [newX, newY]
      }
      return memo
    },
    [xBounds, yBounds, x, y, setX, setY]
  )
  const bind = useGesture({ onWheel: zoom, onDrag: drag }, { domTarget })
  useEffect(() =&gt; {
    domTarget &amp;&amp; bind()
  }, [domTarget, bind])
  return [{ x, y, z }, bind]
}

export const App = ({children}) =&gt; {
  const bound: [number, number] = [-200, 200]
  const [{ x, y, z }] = useControl(bound, bound, bound, { domTarget: window })
  return (
    &lt;a.group
      position-x={x.interpolate(x =&gt; (x / 500) * 10)}
      position-y={y.interpolate(x =&gt; (x / 500) * 10)}
      position-z={z.interpolate(x =&gt; (x / 500) * 25)}
    &gt;
      {children}
    &lt;/a.group&gt;
  )
</code></pre><p>The <code>App</code> exported above wraps all the children models in a God&#x27;s view that can be zoomed and translated.</p></div></div></main><footer>© <!-- -->2021<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/react-based-3d-components";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-818af64753e5306e538b.js"],"app":["/app-5c2916b261110a942aba.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-b0556ce5127c1a3e2490.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-a5780fd25427dba554e6.js"],"component---src-pages-contact-tsx":["/component---src-pages-contact-tsx-6e01bfbd9b9e3535a9b7.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-f451d7b1cde1ede15351.js"],"component---src-pages-post-tsx":["/component---src-pages-post-tsx-006378b48e558ceea283.js"],"component---src-template-blog-tsx":["/component---src-template-blog-tsx-511ea8db97ab7255d585.js"],"component---src-template-resume-tsx":["/component---src-template-resume-tsx-93d7b1a3436304bfd202.js"]};/*]]>*/</script><script src="/polyfill-818af64753e5306e538b.js" nomodule=""></script><script src="/component---src-template-blog-tsx-511ea8db97ab7255d585.js" async=""></script><script src="/c67bc222f24cf6cac9dade081f06b9686691a306-5cb5fd77d6c6846ab638.js" async=""></script><script src="/app-5c2916b261110a942aba.js" async=""></script><script src="/d5b08420-07f367315fbba8850a0e.js" async=""></script><script src="/fb7d5399-58798ebfc9c8cc593565.js" async=""></script><script src="/4bdf9057-bb8d6e3074bb6e323a3e.js" async=""></script><script src="/framework-beda7bde9d7dca0755ce.js" async=""></script><script src="/webpack-runtime-38050ada14d0c54770e0.js" async=""></script></body></html>