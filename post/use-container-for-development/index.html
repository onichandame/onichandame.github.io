<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.21.21"/><title data-react-helmet="true">Onichandame&#x27;s Home-Use Container for Development | Onichandame&#x27;s Home</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="Use Container for Development"/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Xiao Zhang"/><meta data-react-helmet="true" name="twitter:title" content="Use Container for Development"/><meta data-react-helmet="true" name="twitter:description" content=""/><link rel="icon" href="/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link as="script" rel="preload" href="/webpack-runtime-dd010bb15fdd0a8981a1.js"/><link as="script" rel="preload" href="/framework-0c157ddbcea1bac94383.js"/><link as="script" rel="preload" href="/4bdf9057-d1f2f728a56eb4896986.js"/><link as="script" rel="preload" href="/fb7d5399-1756c3d3f6f764424c9f.js"/><link as="script" rel="preload" href="/d5b08420-0d926a1945c521a381de.js"/><link as="script" rel="preload" href="/app-3f35f0fcbd929fd5a7de.js"/><link as="script" rel="preload" href="/c67bc222f24cf6cac9dade081f06b9686691a306-b4418df3ce7b0918796c.js"/><link as="script" rel="preload" href="/component---src-template-blog-tsx-538be02797d6b4522b70.js"/><link as="fetch" rel="preload" href="/page-data/post/use-container-for-development/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="position:fixed;top:0;right:0;bottom:0;left:0"><div style="position:relative;width:100%;height:100%;overflow:hidden"><canvas style="display:block"></canvas></div></div><div style="pointer-events:stroke;position:absolute;width:100vw"><div><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionSticky MuiAppBar-colorPrimary jss2 MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><h6 class="MuiTypography-root MuiTypography-h6"><a class="jss182" href="/">Onichandame&#x27;s Home</a></h6></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/post"><span class="MuiTypography-root MuiTypography-button">blog</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/about"><span class="MuiTypography-root MuiTypography-button">about</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/contact"><span class="MuiTypography-root MuiTypography-button">contact</span></a></div></div></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><div><button class="MuiButtonBase-root MuiButton-root MuiButton-text" tabindex="0" type="button" aria-controls="language-selector" aria-haspopup="true"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></span></button></div></div><div class="MuiGrid-root MuiGrid-item"><a class="MuiButtonBase-root MuiIconButton-root" tabindex="0" aria-disabled="false" href="https://github.com/onichandame"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path></svg></span></a></div></div></div></div></div></header><main class="jss1"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-direction-xs-column"><div class="MuiGrid-root MuiGrid-item"><h3 class="MuiTypography-root MuiTypography-h3">Use Container for Development</h3></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">onichandame</span></div><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">2020-9-16</span></div></div></div><div class="MuiGrid-root MuiGrid-item"><ul><li><a href="#thoughts">Thoughts</a></li><li><a href="#challenges">Challenges</a><ul><li><a href="#podman">Podman</a></li><li><a href="#keep-container-running">Keep Container Running</a></li><li><a href="#reduce-image-size">Reduce Image Size</a></li><li><a href="#nofile-limit">NOFILE Limit</a></li><li><a href="#utf-8-encoding">UTF-8 Encoding</a></li><li><a href="#windows-10">Windows 10</a><ul><li><a href="#docker-engine">Docker Engine</a></li><li><a href="#hyperv">HyperV</a></li></ul></li><li><a href="#kubernetes">Kubernetes</a><ul><li><a href="#setup">Setup</a></li></ul></li></ul></li><li><a href="#implementation">Implementation</a></li></ul><p>As a full-time developer working in office, I have to regularly switch between &#x27;working-at-home&#x27; and &#x27;working-at-office&#x27; modes. Thus it comes with a major problem: how to synchronize the development environment at home and the office?</p><h1 id="thoughts">Thoughts</h1><p>The first thought that naively comes to my mind is automating the setup process of the development environment. As a half DevOps, scripting is the first tool that comes up when I need to solve a problem.</p><p>However, scripting does not treat different OS/platforms equally. So I have to write different scripts for different OS. This approach does not guarantee the synchronization between different OS. Therefore scripting does not help.</p><p>Now the Container comes to rescue. I had to deal with containers a lot for work so it is not too unfamiliar. Container suits the need for the following reasons:</p><ol><li>abstracts the OS so only 1 OS needs to be considered</li><li>sharing files with different host OS is easy</li><li>available on most major OS</li></ol><h1 id="challenges">Challenges</h1><p>It is not trivial to use container for development. First of all I need to access the tty of a container using <code>-it</code> flag. Then the development files need to be stored on the host for permanent storage using <code>-v</code> flag. Lastly flag <code>-p</code> is required to map the ports of the container and the host. Apart from these common setup, several unusual problems need to be solved.</p><p>Basic knowledge of Linux configuration and commands are preassumed.</p><h2 id="podman">Podman</h2><p>Podman is a daemonless container runtime. It requires <code>--security-opt label=disable</code> to bypass SELinux for sharing files with the host.</p><p>Podman treats containers differently than Docker. Each plain container created by podman is not allocateda new IP as it would require root permission. To communicate 2 rootless containers, a pod is requried to contain the 2 containers. The <a href="https://developers.redhat.com/blog/2019/01/15/podman-managing-containers-pods/">official guide</a> tells how to setup pods and containers within pods. <a href="https://www.redhat.com/sysadmin/container-networking-podman">This guide</a> tells how to setup communication between containers in the same pod. However, the creation of pod requires pulling image from k8s.gcr.io, which is blocked by GFW. Thus a mirror registry must be used.</p><p>According to <code>man container-registries.conf</code>, the system-wide configuration is <code>/etc/containers/registries.conf</code>. The location may differ on different platforms, check it carefully. In the default configuration shipped with CentOS 8, the format v1 is used. Mirrors are only available in format v2, therefore the configuration needs to be changed to v2:</p><pre><code class="language-text">unqualified-search-registries = [&#x27;docker.io&#x27;, &#x27;registry.access.redhat.com&#x27;, &#x27;registry.fedoraproject.org&#x27;, &#x27;registry.centos.org&#x27;]

[[registry]]
prefix=&quot;k8s.gcr.io&quot;
location=&quot;k8s.gcr.io&quot;

[[registry.mirror]]
location=&quot;registry.cn-hangzhou.aliyuncs.com/google_containers&quot;
</code></pre><p>Thanks to <a href="https://github.com/containers/libpod/issues/5764">this issue</a></p><p>After removing the old configuration and adding the above configuration, an AliCloud mirror is used. Now the pod can be created.</p><p>The containers inside pods cannot communicate directly with host, namely port mapping. The port mapping needs to be set on the creation of the pods.</p><pre><code class="language-bash">podman pod create -p 30000:3000
</code></pre><h2 id="keep-container-running">Keep Container Running</h2><p>A container will exit as soon as the PID 1 process exits. This is not a problem for stateless container run by <code>docker run -it --rm</code>. But on kubernetes, all containers has to be run in background and use <code>kubectl exec -it</code> to enter the interactive shell.</p><p>To run a container in background indefinitely, several options are available:</p><ol><li><code>tail -f /dev/null</code></li><li><code>bash</code></li></ol><p>The first option has a problem that it does not respond correctly to SIGKILL/SIGINT. Therefore the pod will be stuck in the <code>Terminating</code> stage forever.</p><p>The second option requires a pseudo-tty session to keep the bash from exiting.</p><p>To conclude, the <code>tail</code> approach has no elegant workaround for its problem, whereas the <code>bash</code> approach&#x27;s problem can be fixed by simply providing a pseudo-tty session.</p><h2 id="reduce-image-size">Reduce Image Size</h2><p>The final image size mainly depends on the choice of the Linux distro. The traditional distros like CentOS is not optimized for containerization so the images based on it are inevitably bloated. My choice is Alpine 3. The image based on Alpine 3 weighs around 1.8 GB whereas the CentOS version weighs more than 3 GB.</p><h2 id="nofile-limit">NOFILE Limit</h2><p>When developing a frontend with plenty of source files and dependencies, the development server usually needs to watch all the changes in the source files. This sometimes exceeds the system&#x27;s watch file limit.</p><p>The watch file limit is defined by a hard limit and a soft limit. When the soft limit is exceeded, the user is warned. When the hard limit is hit, the watcher&#x27;s process throws an error. Therefore both limits need to be raised.</p><p>The solution is to increase the host&#x27;s NOFILE limit. The containers automatically inherits the host&#x27;s limit. <a class="" href="/post/ulimit">Check this</a> for the detailed setup.</p><h2 id="utf-8-encoding">UTF-8 Encoding</h2><p>As the base image is usually minimized for performance, the default encoding is set to ASCII. This won&#x27;t be a problem if the host machine has UTF-8 enabled and that container interface directly displays the output as the encoded characters are passed straight to the host for decoding. However, it gets problematic when using tmux inside the container as tmux only passes the decoded character to the screen which it does not understand.</p><p>The first step is the add special characters to the container. In my case, I added Simplified Chinese by installing <code>glibc-langpack-zh</code>. Run <code>locale -a</code> to check if the desired language has been installed.</p><p>The last step is setting the default encoding to UTF-8 by adding <code>export LANG=&quot;zh_CN.UTF-8&quot;</code> and <code>export LC_ALL=&quot;zh_CN.UTF-8&quot;</code> to bashrc.</p><h2 id="windows-10">Windows 10</h2><p>Docker was originally made for Linux. Running in on Windows is always troublesome. Here I records the main issues solved for Windows 10.</p><h3 id="docker-engine">Docker Engine</h3><p>At the time writing this sentence, Docker Desktop mainly provides 2 engines: HyperV(legacy) and WSL 2.</p><p>HyperV works as a traditional VM hypervisor, which is utilized by Docker Desktop to maintain a VM where the docker daemon is run.</p><p>WSL 2 on the other hand, provides a deeply integrated Linux kernel. This is a faster solution so I choose to use this engine.</p><p>The first step is to install WSL 2. Check <a href="https://docs.microsoft.com/en-us/windows/wsl/wsl2-install">this</a> for the official guide.</p><p>Having WSL 2 installed, now check the <strong>Use the WSL 2 based engine</strong> option in the General settings of the Docker Desktop. Restart the docker daemon for this action to take effect. <strong>Note: by restarting the daemon, all the images in the old daemon will be lost!</strong>.</p><p>WSL 2 at this moment suffers from a fatal bug. If you try to start a Linux distro backed by WSL 2, and see the error message <strong>the attempted operation is not supported for the type of object referenced.</strong>, it means that WinSock has caused the WSL 2 to collapse. According to <a href="https://github.com/microsoft/WSL/issues/4177">this issue</a>, running <code>netsh winsock reset</code> as admin works around the bug once and for all.</p><h3 id="hyperv">HyperV</h3><p>No matter you choose HyperV or WSL 2 as the engine, HyperV service must be enabled. However, MicroSoft made a very bad default behaviour that disables virtualization in BIOS once the HyperV related services are enabled. Thus it is required to go to BIOS and enable hardware virtualization after enabling HyperV every time.</p><p>Thanks to <a href="https://answers.microsoft.com/en-us/windows/forum/all/resolving-wslregisterdistribution-error-0x80370102/412cf42b-1424-444c-bb95-4aa2b5fe5eaf">this issue</a></p><h2 id="kubernetes">Kubernetes</h2><p>My production environment is kubernetes, local or cloud. Therefore it would be more convenient for me to setup a development environment that is consistent with the production environment.</p><p>To run development environment in kubernetes, things are different.</p><h3 id="setup">Setup</h3><p>Setting up a kubernetes cluster is not as straightforward as running Docker Desktop. The official way to setup a development cluster is <a href="https://minikube.sigs.k8s.io/">minikube</a>. But I choose to use <a href="https://kind.sigs.k8s.io/">kind</a> as it is more consistent across different platforms than <a href="https://minikube.sigs.k8s.io/">minikube</a>.</p><p><a href="https://kind.sigs.k8s.io/">kind</a> provides an official executable to manage the cluster. One can follow the official guides to install it.</p><p>Based in China, Google services including the gcr registry is not available. Therefore a mirror registry must come to rescue. <a href="https://kind.sigs.k8s.io/">kind</a> receives such configurations from a yaml file, just like how k8s receives configuration for a deployment. I have created <a href="https://github.com/onichandame/docker-dev/blob/master/kube/cluster.yaml">a configuration file</a> for it.</p><p>One thing to note here is the <code>nodes.role.extraMounts</code> should be modified to map a directory on the host machine to the worker node, if persistent storage is desired.</p><p>Having saved the configuration into cluster.yaml, one can boot up a cluster by running the command below:</p><pre><code class="language-bash">kind create cluster --config git/kube/cluster.yaml
</code></pre><p>The next step is to install ingress controller. From my experience it would be very inconvenient if services are exposed to different ports instead of a single port but different domains.</p><p>According to the <a href="https://kind.sigs.k8s.io/docs/user/ingress/">official doc</a>, one can choose an ingress controller from 3: Ambassador, Contour and Nginx. Based on my experiments, only the ambassador works well in China. To install the ambassador controller, run the following commands.</p><pre><code class="language-bash">kubectl apply -f https://github.com/datawire/ambassador-operator/releases/latest/download/ambassador-operator-crds.yaml
kubectl apply -n ambassador -f https://github.com/datawire/ambassador-operator/releases/latest/download/ambassador-operator-kind.yaml
</code></pre><p>After all the pods in the namespace <code>ambassador</code> are up, the controller is ready for use.</p><p>Another concern is that all the ingresses using ambassador should be annotated by <code>kubernetes.io/ingress.class: ambassador</code> so that the ambassador controller is notified to expose the annotated ingress.</p><p>To install other ingress controllers, the administrator needs to make sure that the gateway is installed on the node where the the extra port mapping rules are applied.</p><p>I choose to install Istio as it provides many more useful features relating to the monitoring stuff.</p><ol><li>Run <code>curl -L https://istio.io/downloadIstio | sh -</code> to download the latest CLI of Istio.</li><li>Run <code>istioctl install -f istio.yaml</code> where the <em>istio.yaml</em> can be found at <a href="https://github.com/onichandame/docker-dev/blob/master/kube/istio.yaml">here</a>.</li></ol><p>Now the Istio default profile has been installed.</p><p>The last manual setup is to label the namespace by <code>istio-injection=enabled</code> which tells Istio to inject sidecar proxy to every pod in the namespace. This is required to enable most core functionalities of Istio.</p><p>One caveat currently not resolved is the that the coredns service may stop resolving domain names after the host being restarted. This can be worked around by restarting the coredns deployment on host restart.</p><pre><code class="language-bash">kubectl rollout restart deploy/coredns -n kube-system
</code></pre><h1 id="implementation">Implementation</h1><p>The structure of the source project is as follows:</p><p><img src="/image/container-development-structure.png" alt="struc"/></p><p>The Dockerfile is the instruction to build the final image.</p><p>The files folder contains all the configuration files like vimrc and bashrc.</p><p><a href="https://github.com/onichandame/docker-dev/">Check this</a> for the source files.</p><p><a href="https://hub.docker.com/repository/docker/onichandame/docker-dev">Check this</a> for the built image.</p></div></div></main><footer>Â© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/use-container-for-development";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-3f35f0fcbd929fd5a7de.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-ac91495a5202f90f8ab8.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-66565a40f9652498fa6b.js"],"component---src-pages-contact-tsx":["/component---src-pages-contact-tsx-68fa4e4b721688547eee.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-f4903804c4ca62b23001.js"],"component---src-pages-post-tsx":["/component---src-pages-post-tsx-78f64c5d17e26af2825d.js"],"component---src-template-blog-tsx":["/component---src-template-blog-tsx-538be02797d6b4522b70.js"],"component---src-template-resume-tsx":["/component---src-template-resume-tsx-52fd3ffeb5c949b46b9c.js"]};/*]]>*/</script><script src="/component---src-template-blog-tsx-538be02797d6b4522b70.js" async=""></script><script src="/c67bc222f24cf6cac9dade081f06b9686691a306-b4418df3ce7b0918796c.js" async=""></script><script src="/app-3f35f0fcbd929fd5a7de.js" async=""></script><script src="/d5b08420-0d926a1945c521a381de.js" async=""></script><script src="/fb7d5399-1756c3d3f6f764424c9f.js" async=""></script><script src="/4bdf9057-d1f2f728a56eb4896986.js" async=""></script><script src="/framework-0c157ddbcea1bac94383.js" async=""></script><script src="/webpack-runtime-dd010bb15fdd0a8981a1.js" async=""></script></body></html>