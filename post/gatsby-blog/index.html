<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.21.21"/><title data-react-helmet="true">Onichandame&#x27;s Home-Blog made by Gatsby | Onichandame&#x27;s Home</title><meta data-react-helmet="true" name="description" content=""/><meta data-react-helmet="true" property="og:title" content="Blog made by Gatsby"/><meta data-react-helmet="true" property="og:description" content=""/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="Xiao Zhang"/><meta data-react-helmet="true" name="twitter:title" content="Blog made by Gatsby"/><meta data-react-helmet="true" name="twitter:description" content=""/><link rel="icon" href="/favicon-32x32.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=edf3d310d67f8284a562bc3a58c3e761"/><link as="script" rel="preload" href="/webpack-runtime-be0ebb80a321e4275d22.js"/><link as="script" rel="preload" href="/framework-0c157ddbcea1bac94383.js"/><link as="script" rel="preload" href="/4bdf9057-d1f2f728a56eb4896986.js"/><link as="script" rel="preload" href="/fb7d5399-1756c3d3f6f764424c9f.js"/><link as="script" rel="preload" href="/d5b08420-0d926a1945c521a381de.js"/><link as="script" rel="preload" href="/app-15b56aaa091fc6acbb61.js"/><link as="script" rel="preload" href="/c67bc222f24cf6cac9dade081f06b9686691a306-b4418df3ce7b0918796c.js"/><link as="script" rel="preload" href="/component---src-template-blog-tsx-538be02797d6b4522b70.js"/><link as="fetch" rel="preload" href="/page-data/post/gatsby-blog/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div style="position:fixed;top:0;right:0;bottom:0;left:0"><div style="position:relative;width:100%;height:100%;overflow:hidden"><canvas style="display:block"></canvas></div></div><div style="pointer-events:stroke;position:absolute;width:100vw"><div><header class="MuiPaper-root MuiAppBar-root MuiAppBar-positionSticky MuiAppBar-colorPrimary jss2 MuiPaper-elevation4"><div class="MuiToolbar-root MuiToolbar-regular MuiToolbar-gutters"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><h6 class="MuiTypography-root MuiTypography-h6"><a class="jss182" href="/">Onichandame&#x27;s Home</a></h6></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/post"><span class="MuiTypography-root MuiTypography-button">blog</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/about"><span class="MuiTypography-root MuiTypography-button">about</span></a></div><div class="MuiGrid-root MuiGrid-item"><a class="jss182" href="/contact"><span class="MuiTypography-root MuiTypography-button">contact</span></a></div></div></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-align-items-xs-center"><div class="MuiGrid-root MuiGrid-item"><div><button class="MuiButtonBase-root MuiButton-root MuiButton-text" tabindex="0" type="button" aria-controls="language-selector" aria-haspopup="true"><span class="MuiButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>English<svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"></path></svg></span></button></div></div><div class="MuiGrid-root MuiGrid-item"><a class="MuiButtonBase-root MuiIconButton-root" tabindex="0" aria-disabled="false" href="https://github.com/onichandame"><span class="MuiIconButton-label"><svg class="MuiSvgIcon-root" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 .3a12 12 0 0 0-3.8 23.4c.6.1.8-.3.8-.6v-2c-3.3.7-4-1.6-4-1.6-.6-1.4-1.4-1.8-1.4-1.8-1-.7.1-.7.1-.7 1.2 0 1.9 1.2 1.9 1.2 1 1.8 2.8 1.3 3.5 1 0-.8.4-1.3.7-1.6-2.7-.3-5.5-1.3-5.5-6 0-1.2.5-2.3 1.3-3.1-.2-.4-.6-1.6 0-3.2 0 0 1-.3 3.4 1.2a11.5 11.5 0 0 1 6 0c2.3-1.5 3.3-1.2 3.3-1.2.6 1.6.2 2.8 0 3.2.9.8 1.3 1.9 1.3 3.2 0 4.6-2.8 5.6-5.5 5.9.5.4.9 1 .9 2.2v3.3c0 .3.1.7.8.6A12 12 0 0 0 12 .3"></path></svg></span></a></div></div></div></div></div></header><main class="jss1"><div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-2 MuiGrid-direction-xs-column"><div class="MuiGrid-root MuiGrid-item"><h3 class="MuiTypography-root MuiTypography-h3">Blog made by Gatsby</h3></div><div class="MuiGrid-root MuiGrid-item"><div class="MuiGrid-root MuiGrid-container MuiGrid-justify-xs-space-between"><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">onichandame</span></div><div class="MuiGrid-root MuiGrid-item"><span class="MuiTypography-root MuiTypography-caption">2019-5-25</span></div></div></div><div class="MuiGrid-root MuiGrid-item"><ul><li><a href="#background">Background</a></li><li><a href="#challenges">Challenges</a><ul><li><a href="#static-site-generation">Static Site Generation</a></li><li><a href="#internationalization">Internationalization</a><ul><li><a href="#gatsby-plugin-i18n">Gatsby Plugin i18n</a></li><li><a href="#translate-myself">Translate Myself</a></li></ul></li><li><a href="#markdown-and-jsx">Markdown and JSX</a><ul><li><a href="#graphql">GraphQL</a></li><li><a href="#heading-anchor">Heading Anchor</a></li></ul></li><li><a href="#deployment">Deployment</a></li></ul></li><li><a href="#implementation">Implementation</a><ul><li><a href="#gatsby-build-system">Gatsby Build System</a></li><li><a href="#graphql-1">GraphQL</a></li><li><a href="#internationalization-1">Internationalization</a><ul><li><a href="#page-level">Page Level</a></li><li><a href="#field-level">Field Level</a></li></ul></li></ul></li></ul><p>Having read <a href="https://bloggingexplorer.com/self-hosted-blog">this blog</a>, I am convinced to host my personal blog. The most convncing point is that self-hosting blogs give more ways to monetize. Every developer is keen on monetizing his/her skills, just like me.</p><p>So the strategy has been made. Only tactics left undecided. There are 2 ways to build a self-hosted blog in general: using a blog builder such as WordPress, or build from &quot;scratch&quot;. The difference between these 2 options is not actually well defined. I personally consider a tool requiring not web development skills as a blog builder.</p><p>As a half-frontend-developer, I decided to use a proper develper&#x27;s framework for the job: <a href="https://www.gatsbyjs.org">Gatsby</a>.</p><h1 id="background">Background</h1><p><a href="https://www.gatsbyjs.org">Gatsby</a> is a multi-page website generator based on React.js . The stack can be visualized as follows:</p><p><img src="/image/gatsby-stack.png" alt="stack"/></p><p>It can be seen that to use Gatsby, the user is expected to know HTML, CSS, JS, TS and React. Thus it is a great opportunity to self-learn frontend skills.</p><h1 id="challenges">Challenges</h1><p>Before diving into this project, I had no knowledge of Gatsby as a framework. Thus the path I took to learn is also applicable for any other newbie developer who wish to learn Gatsby.</p><h2 id="static-site-generation">Static Site Generation</h2><p>As a Next.js developer, I am used to use server-side code during runtime. However it is forbidden for Gatsby as a Static Site Generator(SSG). This descrepancy has lead me to a dead end for many times. So these are the differences between SSG and SSR(Server Side Rendering):</p><table><thead><tr><th>SSR</th><th>SSG</th></tr></thead><tbody><tr><td>allow server side code at runtime</td><td>does not allow server side code at runtime</td></tr><tr><td>shipped with server executable</td><td>shipped as plain html/css/... files</td></tr><tr><td>dynamically generate pages</td><td>requires rebuild to change page content</td></tr></tbody></table><p>Based on the principle of SSG, 3 baselines need to be followed:</p><ol><li>separate codes for buildtime and code for runtime</li><li>write runtime code as if writing in browser&#x27;s dev tool</li><li>make sure all data can be statically fetched at buildtime</li></ol><h2 id="internationalization">Internationalization</h2><p>Working in a non-English-speaking country, it is necessary to serve audience from both English background and Chinese background. Thus my blog needs to serve contents in both English and Chinese. This is one of the considerations I took when I decided to make my own blogger as no other blogger is popular in both China and the outside world.</p><p>Coming to the implementation part, there are several tools and examples available online that can guide me.</p><h3 id="gatsby-plugin-i18n">Gatsby Plugin i18n</h3><p>The first approach I tried was using a gatsby plugin. This is the best option for a non-blog site. I have used a similar tool for Next.js so this is not too hard to catch up. However this tool does not suit the needs of a blog site as it only provides field level translation. A blog utilizing field level translation is extremely difficult to maintain as all translation sources are kept in JSON files. A blog stored in JSON? No...</p><h3 id="translate-myself">Translate Myself</h3><p>According to <a href="https://github.com/gatsbyjs/gatsby/tree/master/examples/using-i18n/">the official guide</a>, it is possible to achieve field level translation and page level translation at the same time.</p><p>Based on the guide, I made a <a href="https://github.com/onichandame/gatsby-template">template</a> that bundles gatsby with mdx, page level translation and field level translation.</p><h2 id="markdown-and-jsx">Markdown and JSX</h2><p>The most significant difference between a blog and a regular site is that blogs are served in virtually the same layout. For the ease of maintenance, it would be better to keep the source of the blogs in a stable file format that has not changed in the past 10 years. It would also be beneficial if the source and the output are very similar so that overhead is small, and it is visually clear during writing.</p><p>Combining the above considerations, markdown is the best option. Markdown standard is very stable. Although some improvements have been added in the past few years, all plugins keep a very good interoperability and good backward compatibility.</p><p>However, the original markdown is quite limited in terms of functionality. It&#x27;s simplicity constrains its potential, especially for the flexbility of UI. Hence an enhancement needs to be made.</p><p>JSX is a great tool for creating fancy UI. Using markdown as the backbone and occasionally decorated with JSX will provide a decent layout for blogs. Thus <code>gatsby-plugin-mdx</code> is chosen.</p><p>Having decided to adopt mdx, several issues came in the way.</p><h3 id="graphql">GraphQL</h3><p>mdx in Gatsby allows page query. However, I personally do not like to use page query. Moreover, it is not usable in non-page components, which significantly limits its usage.</p><p>Sadly, component level query is not available in mdx as the JSX components in mdx are not compiled to retrieve static data during build time. Therefore the codes like <code>useStaticQuery</code> is left to run in runtime, where the query will not succeed.</p><h3 id="heading-anchor">Heading Anchor</h3><p>A very useful markdown enhancement is the anchor of the headings. This is one of the basic requirements for table of contents. However, <code>gatsby-plugin-mdx</code> is not shipped with this support.</p><p>According to <a href="https://johno.com/mdx-table-of-contents-components-in-gatsby">this blog</a>, this feature can be easily added.</p><h2 id="deployment">Deployment</h2><p>The last problem is to host the site. There are generally 3 methods to choose:</p><ol><li>buy a managed hosting service</li><li>host on a self-managed server</li><li>find a free hosting service</li></ol><p>The option 1 and 2 are for lazy users who do not want to spend time digging the internet. I happen to know a hosting service for free: Github Pages.</p><p>Github Pages can be easily set up following the official guide. Bear in mind that there are 2 types of Page: project and personal. The one used for the purpose of this blog is the personal one.</p><h1 id="implementation">Implementation</h1><p>Here I record the detailed implementation of the blog site I made. Basic knowledge of React.js is preassumed.</p><h2 id="gatsby-build-system">Gatsby Build System</h2><p>The first thing to learn is the build system of gatsby.</p><p>The source code is written in JSX and the output is static website. There are several fundamental issues here, most have been addressed by Gatsby itself, such as client side routing. One thing that requires special care is the data retrieval.</p><p>People from the background of server side coding may intuitively write codes that are left to run on server during runtime. This is a big no when using Gatsby, or any other <a href="#static-site-generation">SSG</a> tool. Gatsby only allows 2 runtimes: buildtime and browser runtime.</p><p>During buildtime, all data are retrieved to create static HTML. During browser runtime, only browser API is available.</p><p>The codes for buildtime reside in the following locations:</p><ol><li>page query and static query(GraphQL queries are run once at buildtime)</li><li><code>gatsby-node.js</code>, <code>gatsby-config.js</code>, <code>gatsby-browser.js</code> and <code>gatsby-ssr.js</code> under the project&#x27;s root directory</li></ol><p>All other codes are compiled to static HTML at buildtime.</p><p>For details of the <code>gatsby-node.js</code> etc. see <a href="https://www.gatsbyjs.org/docs/conceptual-guide/">the conceptual guid</a>.</p><h2 id="graphql-1">GraphQL</h2><p>The usage of GraphQL in Gatsby is somewhat unusual. In traditional data retrieval modes, a client fires a query to a backend API and the backend respond with the required data. Naively I thought it happens during runtime. But Gatsby runs all GraphQL queries during buildtime. Then all the queries are stripped away from the output.</p><p>Therefore all the queries must be given all the required data and schema during buildtime. One of the main sources of data is <code>gatsby-config.js</code> and <code>gatsby-node.js</code>. check <a href="https://www.gatsbyjs.org/docs/conceptual-guide/">the guide</a> for details.</p><h2 id="internationalization-1">Internationalization</h2><p>To unify page level and field level internationalization, the following design is made.</p><h3 id="page-level">Page Level</h3><p>Only mdx files are accepted for page level translation, such as posts and resume page.</p><p>The example source structure of a post is:</p><p><img src="/i18n-post.png" alt="post"/></p><p>All translations of the page are kept in one folder, which is named as the slug of the post. The file name represents the locales. All the information is extracted by codes in <code>gatsby-node.js</code> then is passed down to the corresponding pages.</p><p>As all the pages have the same layout, a template is passed to the <code>gatsby-plugin-mdx</code> that is applied to all post pages.</p><h3 id="field-level">Field Level</h3><p>Field level translations are kept in a similar structure, where the file name represents the locale. A custom hook is used to retrieve those translations.</p><p>Check <a href="https://onichandame.com">my blog</a> for the final result!</p></div></div></main><footer>© <!-- -->2020<!-- -->, Built with<!-- --> <a href="https://www.gatsbyjs.org">Gatsby</a></footer></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/post/gatsby-blog";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-15b56aaa091fc6acbb61.js"],"component---cache-caches-gatsby-plugin-offline-app-shell-js":["/component---cache-caches-gatsby-plugin-offline-app-shell-js-ac91495a5202f90f8ab8.js"],"component---src-pages-404-tsx":["/component---src-pages-404-tsx-66565a40f9652498fa6b.js"],"component---src-pages-contact-tsx":["/component---src-pages-contact-tsx-fb2d7fdf6de90e811a57.js"],"component---src-pages-index-tsx":["/component---src-pages-index-tsx-f4903804c4ca62b23001.js"],"component---src-pages-post-tsx":["/component---src-pages-post-tsx-78f64c5d17e26af2825d.js"],"component---src-template-blog-tsx":["/component---src-template-blog-tsx-538be02797d6b4522b70.js"],"component---src-template-resume-tsx":["/component---src-template-resume-tsx-52fd3ffeb5c949b46b9c.js"]};/*]]>*/</script><script src="/component---src-template-blog-tsx-538be02797d6b4522b70.js" async=""></script><script src="/c67bc222f24cf6cac9dade081f06b9686691a306-b4418df3ce7b0918796c.js" async=""></script><script src="/app-15b56aaa091fc6acbb61.js" async=""></script><script src="/d5b08420-0d926a1945c521a381de.js" async=""></script><script src="/fb7d5399-1756c3d3f6f764424c9f.js" async=""></script><script src="/4bdf9057-d1f2f728a56eb4896986.js" async=""></script><script src="/framework-0c157ddbcea1bac94383.js" async=""></script><script src="/webpack-runtime-be0ebb80a321e4275d22.js" async=""></script></body></html>